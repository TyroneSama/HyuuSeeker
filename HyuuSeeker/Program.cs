//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXKkdoc:c:;c::;;:lx0XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXKkl;;;;cloxxkOkkxoc;,;;;coOXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXKx;.,lxOO0Oxl:,:llllllc:;'',dXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXKl.,dOOOOOx:.;ld0XKXXKXXKXXKKXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXO',kOOO0Ox,.dKXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXK:.oOOOOd',d00kdddddddddddddddddddddddddOKXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX0xc::xk';kOOo. '::c:;:ccccccccccccccccccccc:;';lk0XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXKKxc;,,:c;',..cOk:':ldkO0O00OO0O000Okxddolcccloddkxl;,,:xKXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXOo:;:;;oxOO0Oko;'ckOkOOOOO000OOOO0Odl:;;;;:::col::;;,;lxkd;.;xKXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXKklc:;,cdkOO0OO00OO0OOOOOOO000000OOOO00koccoxOO0000000OOOd:,';dkx;.;xKXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXKx;.,ldkO0OOOOO0O00OO0OOOOOOO000000OO000O0OO0OOOOOO000OOO00O0ko;.,okd;.;kXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXk;.;dO00O00OOOOOOO00OO0OO00O000OOO0000OO0OO0O00OOOOOO00O0000OOO0Od,.oOOd'.o0XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXO;.lkOOO00000OOO00000OOOOO000000OOOOO0000000000000000OOO0000OOOO0OOx''lkOkc.;kKXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX0;.oOOO0OOOO000OO00000OOO000000000OOOOOOOOO000000000OOOOOO000OOOOOO0Ox:.;kOOd'.dXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXKc.cOOOOOOOO0000OOOO0000O00000OOO00000000OOOO0000000OOO000OO000000OOOOOOl.,dOOk,.xKXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXKl.cOOOOOOOO00000O0O0000O0OOO00OOO00O0OO0OO00000000OOOOO0OO0OO00000OOOOOOOd,.o0Ox'.xXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXx.;OOO0OOOO0000OOO0000OO0Oxk0000OO000OOOOkkOO0000OOOOOOO0OOO000000000000000x,'dOOd''kXXXXXXXk:cl:cx0XXXXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXK:.dOOOOO00OOOOOOOOO00OOOOl.l0OOOOOO0OOOxc'cOOOO0OOOO0OO00OOOO00000OOOO0000OOd''dOOd,'dKXXXXXO;.okl;;:xKXXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXd.:O0OOOOO00OO0000000OOOx:..c0OOOOO00OOo'..:OO000OOOO0dcxOO0OO00000OOOO0000OOOd''dOOx,.oXXXXXX0:.o0d. .:OXXXXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:.d0OOOOO0O0OO0000O0OOkc',.'x0O0OOOOOOo.;O:'okOO0O00OOl.;k0OOOO0000OOO0000OOOOOo.,xOOx;.oKXXXXXKo..     .d0XXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXk';OOO00O0OOOOO0000OOOx;.dk,;kOO0O0OOx;':0Wo..l0O00OOO0l..:k0OOOOO00OO00O00OO0OOOc.cOOOk;.oXXXXXX0,        ,kXXXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXKc.oOOOO00Olck0OOOOOOOx,'kNo.l0O00O0kl',kNWWx..cOOOOOOO0c.,':kOOO0OOOOOO000xok0000k,,k0OOx,.oKXXXXk.         .dKXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXX0dkXXXXO,;k0OOO0kc.,x0OOOOOOx,.kMX;,kOO0OOOc.:KWWWWK; .dOO0OOO0c'kd.cOOO00OOO0OOO0o.;k0OOOc.:kOOOd'.xX0x:.            cKXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXx'.dXXXXo.lOOOOOk:. :kOO0OOkc';kNWx.cOO0OOx;'lKWWWWWWk;.:OO0OOO0c'kNc.o0OO0xokOOOOOO:.lOOOOk; .:odd:..,.                :OXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXKo'..dXXXO,'x0OOOk:  'x0OOOOx,'dNWWWo'd0O0Od'.kWWWWWWWWKk;'xOO0OOk,,0W0;'oOO0c'o0OOOO0x,'dOOO0c                            ,OXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXKo.cx,oKOd. :OOOOk:   ;OOOOOd',ONWWWNl'd0Okl.,OWWWWWWWWWWWk':O00O0l.oWWW0;'xOOc.cOOOOOOOo.,xOOOx'                            'kXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXKl..c,..'.   cOO0k;    cOOOOl.;0WWWWW0,;kOk;.oKWWWWWWWWWWWWNl.lOOO0:,0WWWWk':O0c.:O0OO0OOOl.;kOOOo.                            .xXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXX0:           .l0OOc    .d0Od;.:KWWWWWW0,:Oo''xNWWWWWWWWWWWWWWK:.cOOx':XWWWWNc,k0c.:O0OOOOOOOc.o0OOO;                             .lKXXXXXXX
//XXXXXXXXXXXXXXXXXXXXKl            'x0Ol.    ;k0k:..;loONWWWk.;:.c0WWWWWWWWWWWWWWWWWXc.oOl.dWWWWWWc,kk:.:O0000O0O0o.:OOOO:,c'                           .dXXXXXXX
//XXXXXXXXXXXXXXXXXXXXd.           .cOOl. .;..lOOl'l0Ox;.,:ld,  .lKNWWWWW0kXWWWWWWWWWWO''o,.:ddoclo'.;:' :O000000O0k;.lOOO:,kkl.                          ;KXXXXXX
//XXXXXXXXXXXXXXXXXXXd.            .ok:..:OXc'xOl.:XNkc;:cccc. .,::;;;kWWk';oxOxolc:;;,.     'ldk0K:'dkc.:O0000OOO0x'..ckO:,kOOk:.                        ,0XXXXXX
//XXXXXXXXXXXXXXXXXXk.             .dl.:OKXXc'xl. cO:'lKWMMMMxlKNNXOl.lNWWKxo:. 'ldxOOOx, .:lc:cldKl,kOc.:O0000OOOk:.c:.;xl.:kOOk;                        .dXXXXXX
//XXXXXXXXXXXXXXXXXk,              :o';OXXXO,,c.'.;;,0WXkxkKWMMMMMMMNccNWWWWO;;xNMMMMMMM0cxWMMX0d',',xo. ;O0O0OOOOl.'oxl.'o;.lOOOx,                        :KXXXXX
//XXXXXXXXXXXXXXXXk'              .:,,OXXXNx...;:.c;lMWl   cNMMMMMMMNc:NWWWWo,0MMXko::kWMMMMMMMMWO' ,:.;';O0OO0Ok:.;;.;xd,.'.:OOOk,                        'OXXXXX
//XXXXXXXXXXXXXXX0;             ...'.dXXXXXx. ,x:,kl,OWk'..oWMMMMMMMN::NWWWWo,KMWd..  :XMMMMMMMMMX; ..cK:;O0O0Od;.lXNx':0kl. 'x0Ok;                        .xXXXXX
//XXXXXXXXXXXXXXKc              :; .dKXXXXK:  cx':XX:'xNN0KNMMMMMMWO:'dWWWWWd.dWMNKx::kWMMMMMMMMMNc  ;KX:;O0OOo.':;;OX:'x0Ox,'o0Ok;                         cXXXXX
//XXXXXXXXXXXXXXx.              lxckXXXXXXXx..dx'oWWKdccclkOOOOOOx:':ONWWWWWXl':OWMMMMMMMMMMMMMNkc,,oKW0':OOx:':0WO'lWd.cOO0OkO00k;                         cXXXXX
//XXXXXXXXXXXXX0,               cXXXXXXXXXXx.:Ox'oWWWWWXxllooooolld0NWWWWWWWWNO:':ldkkkkkkkkxoc:;lONWWWo.lkl..'dXWX;lW0,;kOOO0O00k;                         ;KXXXX
//XXXXXXXXXXXXXo.               lXXXXXXXXXK:'d0x'oWWWWWWWWWWWWWWWWWWWWWWWWWWWWWNKxooooooooooodk0NWWWWW0;,l'..;l,oNK;lWWc,k0OO00OOk;                         .xXXXX
//XXXXXXXXXXXXk.                lXXXXXXXXX0;;O0x'oWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWNc ..:k:;KXKWK;lWK;,kOO00OOOk;                         .dXXXX
//XXXXXXXXXXXKc                 lXXXXXXXXXd.cOOx'oWWWWWWWWWWWWWWKOXWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWNd..:ONWc;KWWNo.dNl.lOOO00OO0x'                          :KXXX
//XXXXXXXXXXXk.                 :KXXXXXXXXl.dOOx'oWWWWWWWWWWWWWWO:;kWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWNkoONWNx'lNNx;'dKo.:k00O000OOl.                          ,0XXX
//XXXXXXXXXX0:                  .xXXXXXXX0;'xOOx'lNWWWWWWWWWWWWWWN0XWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWNOooo;'o00c.ck0O00O00Ok:                           .dXXX
//XXXXXXXXXXd.                   :KXXXXXXx.:OO0k:.xWWWWWWWWWWWWWWWNKOkkk0XNNWWWWWWWWWWWWWWWWWWWWWWWWWWXooXWWKxxkKKl',oO0OO0OO0O0d.     ...                    oXXX
//XXXXXXXXXK:                    ;KXXXXXXc.oOOOOx,'xNWWWWWWWWWWWNOc,clolcoocclxKNWWWWWWWWWWWWWWWWWWWWK:.,dxxxxxxl,,lkOO00O0OOOOO:    .:xkx;                   cKXX
//XXXXXXXXXx.                .;:;dKXXXXXO,;k0OOOOx:';kNWWWWWWWNk:':OWWWWWWWXOd:;:oxONWWWWWWWWWWWWWWNO;..cccccccccokOOOO0OOOOOOOd.  .:dOOOOk:                  'OXX
//XXXXXXXX0,               'd0XXXXXXXXXXl.lOOOOO0OOx;.cKWWWWWWk':0NWWWWWWWWWWWWXxc:,;xXWWWWWWWWWWKx:':,.oOOOO0O00OOO00OO0OO0OOO:  ;xOOOOOOOk,                 .kXX
//XXXXXXXXO'             .lKXXXXXXXXXXXO',kOOOOO0OOOkl''oKWWWWd;OWWWWWWWWWWWWWWWWWWKo,oNWWWWWWKxl,;d0Nl .;oxc:dO00O00000OOO0OOo''oO00OO0OOOOx'                 cXX
//XXXXXXXXo             .lKXXXXXXXXXXXXl.lO00OOO000OOOkl''lONWXKNWWWWWWWWWWWWWWWWWWWWXKWWNK0x:,:oOXWWWx::....cx00000000000000Okdk0000OO0OOOOOl.                :KX
//XXXXXXXO,             ;KXXXXXXXXXXXXO,,k0O00O000OOOOOOko;.:xKWWWWWWWWWWWWWWWWWWWWWWN0xc::lcd0NWWWWWWWWXc .oOO0O000OOOO00O00OOOO000OOOO00000x,        ..      .kX
//XXXXXXXd.             :KXXXXXXXXXXXXd.c0OO00OO0OOOOOO0OOOdc,,cokXXXXXXXXXXXKOkxolol:;cdOXWWWWWWWWWWWWWK;.dOOOOOOO0000000OOOOOOOOOOO0OO000OOO:      ,dkOo;.   .xX
//XXXXXXK:              :XXXXXXXXXXXXK:.d0OO0000OOOOOO000OO0Okxl:;cc,;ooooooolcloddkO0XWWWWWWWWWWWWWWWWX:.cxO0OOOOO0000000O0000OO0OO0000000OOO:     ,OXXXXXO;  .xX
//XXXXXX0,       .,.    :KXXXXXXXXXXXx.:OOO0O00000OO0000OOOO0OOOOOkc.'odddddddddddddddddddddddddddddoc;,...,d0O0000OO0OOOOO000OO00O00000000OOO:    :0XXXXXXXK: .xX
//XXXXXXd.     .cOXOl,  :KXXXXXXXXXXK:'dOOOOOOOOO0OOO0OOO0OOOOOOOo. ..  .....  ......... .......  .... ... 'xOO0000OOOOOO000000OOO000000000OOO:  .lKXXXXXXXXX0ooOX
//XXXXXK:     :OXXXXXKc.cXXXXXXXXXXXk':OxolllllllllllloxxkOOO0OOd. ... ...... .......... ....... ..... ....cOOOOOO00OOO000000000OOO0OOO0000OOO:  :KXXXXXXXXXXXXXXX
//XXXXXO'   .dKXXXXXXXKO0XXXXXXXXXXK:.::. ................,;cccl' ........... ......... ..................;xOkxdddoccccccccccccodddkOOOOO0OO0Oc'.'kXXXXXXXXXXXXXXX
//XXXXXd. .cOXXXXXXXXXXXXXXXXXXXXXXo. .........................   ..................... ................  ',''......................,lkOOO0OOOkkl.dXXXXXXXXXXXXXXX
//XXXXXc ,kKXXXXXXXXXXXXXXXXXXXXXXO, ................................................................... .............................':dOOOOOO0d':KXXXXXXXXXXXXXX
//XXXXXkd0XXXXXXXXXXXXXXXXXXXXXXKd............................  ....................................................................... .'ckOOO0O:,OXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXX0c................................  ............................  ......................................... .oOOOOl.oXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXXx'...................................  ......................  .............................................. .cOO0d'cXXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXXd. ....................................  ...................  ...................................................:kOk,,OXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXXd. ......................................................  ....................................................... 'd0c'kXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXXx. ................................................................................................................. c0c'kNXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXXO, ...................................................................................................................c0l.oXXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXKc.................................................................................................................... ,xk':KXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXx.................  ....................................................................................................dk,;0XXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXo................ ......................................................................................................dOc.dNXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXXo..............  .......................................................................................................d0o.dNXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXK:.............  ................................................................. ......................................d0l.dXXXXXXXXXXXX
//XXXXXXXXXXXXXXXXXXXXXXO'............. .................................................................. ......................................d0l.dNXXXXXXXXXXX

// I'm not a programmer. Don't judge me too harshly.

using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Sockets;
using System.Runtime.InteropServices;
using System.Text;
using System.Text.RegularExpressions;
using HtmlAgilityPack;
using System.Diagnostics;

namespace HyuuSeeker
{
    class Program
    {

        [StructLayout(LayoutKind.Sequential, Pack = 0)]
        struct PacketHeader
        {
            public int Checksum;
            public byte Ack;
            public byte AckReturn;
            public byte PacketType;
            public byte Reserved;
        }

        [StructLayout(LayoutKind.Sequential, Pack = 0)]
        unsafe struct PT_SERVERINFO
        {
            public byte Version;
            public byte SubVersion;
            public byte NumberOfPlayer;
            public byte MaxPlayer;
            public byte GameType;
            public byte ModifiedGame;
            public byte CheatsEnabled;
            public byte IsDedicated;
            public byte FileNeededNum;
            public byte AdminPlayer; // unused
            public uint Time;
            public uint LevelTime;
            public fixed byte ServerName[32];
            public fixed byte MapName[8];
            public fixed byte MapTitle[33];
            public fixed byte MapMD5[16];
            public byte ActNum;
            public byte IsZone;
        }

        unsafe struct PT_MOREFILESNEEDED
        {
            public uint First;
            public byte Num;
            public byte More;
        }

        // SPANS ARE MAGIC
        public static unsafe string DecodeString(byte* bytes, int fullLength)
        {
            var span = new Span<byte>(bytes, fullLength);
            var nullIndex = span.IndexOf((byte)0);
            var relevant = span.Slice(0, nullIndex == -1 ? fullLength : nullIndex);
            fixed (byte* pointer = &MemoryMarshal.GetReference(relevant))
                return Encoding.UTF8.GetString(pointer, relevant.Length);
        }

        public static T ReadPacketComponent<T>(Stream stream)
        where T : unmanaged
        {
            var componentSize = Marshal.SizeOf(typeof(T));
            Span<byte> buffer = stackalloc byte[componentSize];
            var read = stream.Read(buffer);
            if (read < componentSize)
                throw new Exception("NIGHTMARE");
            return MemoryMarshal.Cast<byte, T>(buffer)[0];
        }

        // FUCK YOU, THIS ISN'T A CHECKSUM
        static int CalculateChecksum(Span<byte> data)
        {
            var c = 0x1234567;
            for (var i = 0; i < data.Length; i++)
                c += data[i] * (i + 1);
            return c;
        }

        static List<string> DecodeFileNeeded(byte[] packet)
        {
            // WE ARE READING MOREFILENEEDED BYTE BY BYTE BECAUSE THE FIELDS ARE NOT FIXED LENGTH
            // BECAUSE MOREFILENEEDED IS THE WORST THING EVER
            List<string> wantfiles = new List<string>();
            try
            {
                BinaryWriter binWriter = new BinaryWriter(new MemoryStream());
                binWriter.Write(packet);
                BinaryReader reader = new BinaryReader(binWriter.BaseStream);
                reader.BaseStream.Position = 0;
                // get the header out of here
                reader.ReadBytes(8);
                // that's better
                reader.ReadUInt32();
                reader.ReadByte();
                reader.ReadByte();
                while (true)
                {
                    byte status = reader.ReadByte();
                    uint size = reader.ReadUInt32();
                    List<byte> oof = new List<byte>();
                    // THIS IS THE WORST WAY TO BUILD A STRING OUT OF BYTES EVER.
                    while (true)
                    {
                        byte fug = reader.ReadByte();
                        if (fug == 0)
                        {
                            break;
                        }
                        else
                        {
                            oof.Add(fug);
                        }
                    }
                    string filename = Encoding.ASCII.GetString(oof.ToArray());
                    wantfiles.Add(filename);
                    byte[] MD5 = reader.ReadBytes(16);
                }
            }
            catch (Exception ex)
            {
                // FOR NOW WE ARE JUST ASSUMING THAT THIS IS THE END OF THE STREAM.
                // THIS IS IRRESPONSIBLE, BUT I'M DOING IT ANYWAY BECAUSE EVERYTHING IS TERRIBLE.
                return wantfiles;
            }
        }

        static void SendSRB2Packet(UdpClient client, byte type, byte[] payload)
        {
            byte[] header = { 0, 0, type, 0 }; // WHO GIVES A FUCK ABOUT THE RETURN ACK, NOT US APPARENTLY
            byte[] contents = header.Concat(payload).ToArray();
            byte[] sendBytes = BitConverter.GetBytes(CalculateChecksum(contents)).Concat(contents).ToArray();
            client.Send(sendBytes, sendBytes.Length);
        }


        public static void ClearCurrentConsoleLine()
        {
            int currentLineCursor = Console.CursorTop;
            Console.SetCursorPosition(0, Console.CursorTop);
            for (int i = 0; i < Console.WindowWidth; i++)
                Console.Write(" ");
            Console.SetCursorPosition(0, currentLineCursor);
        }

        static void Main(string[] args)
        {
            string hostname = "";
            int intchoice;
            int port = 0;

            if (!File.Exists("maps.kart")) {
                Console.WriteLine("Close this program and move it to your SRB2Kart folder. Then try again.");
                Console.ReadKey();
                return;
            }

            Console.WriteLine("Checking for updates...");
            string version = "PRERELEASE HELLSCAPE 1";
            string remote = new WebClient().DownloadString("https://hyuu.cc/version.txt");
            if (version != remote)
            {
                Console.WriteLine();
                Console.WriteLine("███╗   ██╗███████╗██╗    ██╗    ██╗   ██╗███████╗██████╗ ███████╗██╗ ██████╗ ███╗   ██╗");
                Console.WriteLine("████╗  ██║██╔════╝██║    ██║    ██║   ██║██╔════╝██╔══██╗██╔════╝██║██╔═══██╗████╗  ██║");
                Console.WriteLine("██╔██╗ ██║█████╗  ██║ █╗ ██║    ██║   ██║█████╗  ██████╔╝███████╗██║██║   ██║██╔██╗ ██║");
                Console.WriteLine("██║╚██╗██║██╔══╝  ██║███╗██║    ╚██╗ ██╔╝██╔══╝  ██╔══██╗╚════██║██║██║   ██║██║╚██╗██║");
                Console.WriteLine("██║ ╚████║███████╗╚███╔███╔╝     ╚████╔╝ ███████╗██║  ██║███████║██║╚██████╔╝██║ ╚████║");
                Console.WriteLine("╚═╝  ╚═══╝╚══════╝ ╚══╝╚══╝       ╚═══╝  ╚══════╝╚═╝  ╚═╝╚══════╝╚═╝ ╚═════╝ ╚═╝  ╚═══╝");
                Console.WriteLine();
                Console.WriteLine("The latest version is " + remote + ". You are on " + version + ".");
                Console.WriteLine("Get it at https://hyuu.cc/hyuuseeker.");
                Console.WriteLine("It's better.");
                Console.WriteLine();
                Console.WriteLine("(Update to make this message go away. Press any key to skip it once.)");
                Console.ReadKey();
            }
            Console.Clear();


            Console.WriteLine("HyuuSeeker " + version + " - a horrible Tyron hack");
            Console.WriteLine("\"like wadseeker but written by chimpanzees\"");
            Console.WriteLine("");

            List<string> servers = new List<string>();
            HtmlWeb web = new HtmlWeb();  
            HtmlDocument document;

            try
            {
                document = web.Load("http://hyuu.cc");
            } 
            catch
            {
                Console.WriteLine("Couldn't connect to http://hyuu.cc");
                Console.ReadKey();
                return;
            }

            HtmlNodeCollection nodes = document.DocumentNode.SelectNodes("//div[@class='hyuuseeker-enabled']/li");

            Console.WriteLine("Choose a hyuuseeker supported server to play on!\n");

            int listnumber = 1;
            foreach (HtmlNode node in nodes)
            {
                HtmlNode linknode = node.SelectSingleNode("a");
                HtmlNode descnode = node.SelectSingleNode("div[@class='desc']");
                servers.Add(linknode.Attributes.First().Value);


                Console.WriteLine(listnumber + " : " + linknode.InnerText);
                if (descnode != null)
                {
                    Console.WriteLine("\t" + descnode.InnerText);
                }
                Console.WriteLine("");
                listnumber++;
            }

            Console.WriteLine("Enter a number to select a HyuuSeeker supported server.\nOr, you can type an unsupported hostname directly and HyuuSeeker will try its best.\nYou can also enter nothing and HyuuSeeker will scan your log for previous connections.");
            string target = Console.ReadLine();

            List<string> targets = new List<string>();
            if (target == "")
            {
                Console.WriteLine("Parsing your log.txt for missing files...");
                Regex regex = new Regex(@"^*\s\""(.+)\""\s(.+)\snot\sfound, md5:\s(.+)$");
                using (FileStream log = new FileStream(@"log.txt", FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                {
                    using (StreamReader reader = new StreamReader(log))
                    {
                        string line;
                        while ((line = reader.ReadLine()) != null)
                        {
                            Match match = regex.Match(line);
                            if (match.Success)
                            {
                                string v = match.Groups[1].Value;
                                //Console.WriteLine(v);
                                targets.Add(v);
                            }
                        }
                    }
                }
            } 
            else
            {
                if (Int32.TryParse(target, out intchoice))
                {
                    if (servers[intchoice-1] != null)
                    {
                        Uri uri = new Uri(servers[intchoice-1]);
                        hostname = uri.Host;
                    }
                    else
                    {
                        Console.WriteLine("You entered a number out of the list range, exiting ...");
                        Console.ReadKey();
                        return;
                    }
                }
                else 
                {
                    //Support both bare hostnames and ones with uri
                    if (!target.Contains(Uri.SchemeDelimiter)) {
                        target = string.Concat(Uri.UriSchemeHttp, Uri.SchemeDelimiter, target);
                    }
                    Uri uri = new Uri(target);
                    hostname = uri.Host;
                    port = uri.Port;
                }

                if (port == 0 || port == -1) {port = 5029;}

                UdpClient udpClient = new UdpClient(port);
                udpClient.Client.ReceiveTimeout = 10000;
                Console.WriteLine();
                try
                {
                    Console.WriteLine("Connecting to " + hostname + " on port " + port + "...");
                    try
                    {
                        udpClient.Connect(hostname, port);
                    } catch
                    {
                        Console.WriteLine("Couldn't connect.");
                        Console.ReadKey();
                        return;
                    }
                    //Console.WriteLine("Connected.");
                    SendSRB2Packet(udpClient, 12, new byte[] { 0, 0, 0, 0, 0 }); // HEY CAN I HAVE PT_SERVERINFO
                    IPEndPoint RemoteIpEndPoint = new IPEndPoint(IPAddress.Any, 0);
                    uint start = 0;
                    bool morePackets = true;
                    while (morePackets)
                    {
                        byte[] received = udpClient.Receive(ref RemoteIpEndPoint);
                        Stream stream = new MemoryStream(received);
                        var header = ReadPacketComponent<PacketHeader>(stream);
                        switch (header.PacketType)
                        {
                            case 13: // PT_SERVERINFO
                                Console.WriteLine("Getting server info...");
                                var body = ReadPacketComponent<PT_SERVERINFO>(stream);
                                //start = body.FileNeededNum;
                                break;
                            case 14: // PT_PLAYERINFO
                                SendSRB2Packet(udpClient, 34, BitConverter.GetBytes(start));
                                break;
                            case 35: // PT_MOREFILESNEEDED
                                //Console.WriteLine("Getting file list...");
                                var fileNeeded = ReadPacketComponent<PT_MOREFILESNEEDED>(stream);
                                //Console.WriteLine("first: " + fileNeeded.First + " | num: " + fileNeeded.Num + " | more: " + fileNeeded.More);
                                start = fileNeeded.Num + start;
                                //Console.WriteLine(Encoding.ASCII.GetString(received).ToString());
                                targets.AddRange(DecodeFileNeeded(received));
                                if (fileNeeded.More == 1)
                                {
                                    SendSRB2Packet(udpClient, 34, BitConverter.GetBytes(start));
                                }
                                else
                                {
                                    morePackets = false;
                                }
                                break;
                            default:
                                Console.WriteLine("Unknown packet type: " + header.PacketType);
                                break;
                        }
                    }
                }
                catch (Exception e)
                {
                    Console.WriteLine(e.ToString());
                    return;
                }
            }

            Console.WriteLine("Found " + targets.Count + " files to check.");
            if (targets.Count == 0)
            {
                Console.WriteLine("Try connecting to a server first: I don't know what I need to download!");
                Console.ReadKey();
                return;
            }
            Console.WriteLine();

            Console.WriteLine("Getting mirrors from hyuu.cc...");
            string[] mirrors = new WebClient().DownloadString("https://hyuu.cc/hyuuseeker.txt").Split("\r\n", StringSplitOptions.RemoveEmptyEntries);
            Console.WriteLine("Got " + mirrors.Length + " mirrors.");
            foreach (string m in mirrors)
            {
                //Console.WriteLine(m);
            }
            Console.WriteLine();


            Console.WriteLine("Attempting to download missing files...");
            System.IO.Directory.CreateDirectory("HyuuSeeker");
            bool panic = false;
            List<string> failed = new List<string>();
            foreach (string s in targets)
            {
                var file = Directory.GetFiles(".", s, SearchOption.AllDirectories)
                    .FirstOrDefault();
                if (file == null)
                {
                    bool success = false;
                    foreach (string m in mirrors)
                    {
                        string url = "https://" + m + "/" + s;
                        ClearCurrentConsoleLine();
                        Console.Write("Trying " + url + "...");
                        try
                        {
                            UriBuilder uriBuilder = new UriBuilder(url);
                            WebRequest request = WebRequest.Create(uriBuilder.Uri);
                            HttpWebResponse response = (HttpWebResponse)request.GetResponse();
                            if (response.StatusCode == HttpStatusCode.OK)
                            {
                                try
                                {
                                    //Console.WriteLine("Downloading " + s + "...");
                                    using (var client = new WebClient())
                                    {
                                        // TODO: STOP USING A SCRATCH PATH BECAUSE YOU'RE TOO LAZY TO SET UP A FAKE /DOWNLOAD
                                        client.DownloadFile(url, @"HyuuSeeker\" + s);
                                    }
                                    success = true;
                                    ClearCurrentConsoleLine();
                                    Console.Write("Got " + s + " from " + m + ".");
                                    break;
                                }
                                catch (Exception ex)
                                {
                                    // TODO: WHY????
                                    //Console.WriteLine("Unable to download " + ex.ToString());
                                }
                            }
                        }
                        catch (WebException ex) when ((ex.Response as HttpWebResponse)?.StatusCode == HttpStatusCode.NotFound)
                        {
                            //Console.WriteLine("Couldn't download " + s + ", 404.");
                        }
                        catch (WebException ex)
                        {
                            //Console.WriteLine("Couldn't download " + s + ", something is fucked up and broken." + ex.ToString());
                        }
                    }
                    if (!success)
                    {
                        ClearCurrentConsoleLine();
                        Console.Write("Couldn't download " + s + " from any mirrors.");
                        failed.Add(s);
                        panic = true;
                    }
                    Console.WriteLine();
                } else
                {
                    Console.WriteLine("You already have " + s + ".");
                }
            }
            Console.WriteLine();
            if (panic)
            {
                Console.WriteLine("Downloaded all available files, but some couldn't be retrieved:");
                Console.WriteLine(String.Join(", ", failed.ToArray()));
                Console.WriteLine("You can now close this window.");
                Console.ReadKey();
                return;
            } 
            else
            {
                Console.WriteLine("__     ______  _    _ _          _____      _____ ____   ____  _      ");
                Console.WriteLine("\\ \\   / / __ \\| |  | ( )   /\\   |  __ \\    / ____/ __ \\ / __ \\| |     ");
                Console.WriteLine(" \\ \\_/ / |  | | |  | |/   /  \\  | |__) |  | |   | |  | | |  | | |     ");
                Console.WriteLine("  \\   /| |  | | |  | |   / /\\ \\ |  _  /   | |   | |  | | |  | | |     ");
                Console.WriteLine("   | | | |__| | |__| |  / ____ \\| | \\ \\   | |___| |__| | |__| | |____ ");
                Console.WriteLine("   |_|  \\____/ \\____/  /_/    \\_\\_|  \\_\\   \\_____\\____/ \\____/|______|");
                Console.WriteLine();
            }


            if (hostname != "")
            {
                Console.WriteLine("\nNow launching SRB2Kart and connecting to " + hostname);
                Console.WriteLine("Which renderer would you like to use? (Use Software if unsure)");
                Console.WriteLine("\t1 :  Software (Default)");
                Console.WriteLine("\t2 :  OpenGL");
                Console.WriteLine("\t3 :  Cancel Launch");

                string choice = Console.ReadLine();
                string opengl = "";

                if (Int32.TryParse(choice, out intchoice))
                {
                    if (intchoice >= 3 || intchoice <= 0)
                    {
                        Console.WriteLine("Cancelling launch ...");
                        Console.ReadKey();
                        return;
                    }
                    else if (intchoice == 2)
                    {
                        opengl = "-opengl";
                    }
                }
                else 
                {
                    Console.WriteLine("Numbers allowed only ... exiting ...");
                    Console.ReadKey();
                    return;
                }

                ProcessStartInfo startinfo = new ProcessStartInfo();
                startinfo.FileName = "srb2kart.exe";
                startinfo.Arguments = "-connect " + hostname + " " + opengl;
                try
                {
                    Process.Start(startinfo);
                }
                catch
                {
                    Console.WriteLine("Couldn't start " + startinfo.FileName + " " + startinfo.Arguments);
                    Console.ReadKey();
                }
            }
            else
            {
                Console.WriteLine("Downloaded all missing files. You can now close this window.");
                Console.ReadKey();
                return;
            }
        }
    }
}
